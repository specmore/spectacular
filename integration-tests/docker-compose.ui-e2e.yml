version: '3'
services:
    github-mock:
        image: rodolpheche/wiremock
        volumes:
            - ./integration-tests/github-mock/test:/home/wiremock
    auth:
        image: tarent/loginsrv:1.3.0
        environment: 
            - LOGINSRV_GITHUB=client_id=${SPECTACULAR_GITHUB_CLIENT_ID:?SPECTACULAR_GITHUB_CLIENT_ID needs to be set in a .env file with a GitHub app client id},client_secret=${SPECTACULAR_GITHUB_CLIENT_SECRET:?SPECTACULAR_GITHUB_CLIENT_SECRET needs to be set in a .env file with a GitHub app client secret}
            - LOGINSRV_JWT_SECRET=${SPECTACULAR_JWT_SHARED_SECRET:?SPECTACULAR_JWT_SHARED_SECRET needs to be set in a .env file with a 32byte text secret}
            - LOGINSRV_COOKIE_SECURE="false"
    backend:
        depends_on: 
            - github-mock
        image: spectacular.azurecr.io/test-candidate/backend:${SPECTACULAR_IMAGE_TAG}
        environment: 
            - GITHUB_APP_ID=${SPECTACULAR_GITHUB_APP_ID:?SPECTACULAR_GITHUB_APP_ID needs to be set in a .env file with a GitHub app id}
            - GITHUB_APP_PRIVATE_KEY_FILE_PATH=/usr/spectacular/github.private-key.pem
            - GITHUB_API_ROOT_URL=http://github-mock:8080
            - JWT_SHARED_SECRET=${SPECTACULAR_JWT_SHARED_SECRET:?SPECTACULAR_JWT_SHARED_SECRET needs to be set in a .env file with a 32byte text secret}
        volumes:
            - ${SPECTACULAR_GITHUB_APP_PRIVATE_KEY_FILE_PATH:?SPECTACULAR_GITHUB_APP_PRIVATE_KEY_FILE_PATH needs to be set in a .env file with the location of a .pem private key provided for the GitHub app}:/usr/spectacular/github.private-key.pem:ro
    web:
        image: spectacular.azurecr.io/test-candidate/web:${SPECTACULAR_IMAGE_TAG}
        ports:
        - "80:80"
        depends_on: 
            - backend
            - auth
        environment:
            - API_LOCATION=http://backend
            - AUTH_LOCATION=http://auth:8080
            - GITHUB_APP_INSTALLATION_ID=${SPECTACULAR_GITHUB_APP_INSTALLATION_ID:?SPECTACULAR_GITHUB_APP_INSTALLATION_ID needs to be set in a .env file with a GitHub app installation id}
    cypress:
        image: cypress/included:3.3.2
        depends_on: 
            - web
        volumes:
            - ./integration-tests/ui-e2e:/e2e
        working_dir: /e2e
        environment:
            - CYPRESS_BASEURL=http://web
        entrypoint: ''
